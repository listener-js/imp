var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(n){for(var i,e=1,t=arguments.length;e<t;e++)for(var s in i=arguments[e])Object.prototype.hasOwnProperty.call(i,s)&&(n[s]=i[s]);return n}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var n=0,i=0,e=arguments.length;i<e;i++)n+=arguments[i].length;var t=Array(n),s=0;for(i=0;i<e;i++)for(var o=arguments[i],r=0,a=o.length;r<a;r++,s++)t[s]=o[r];return t},Join=function(){function n(){this.joins={},this.options={},this.promises={},this.resolvers={}}return n.prototype.join=function(lid,n){for(var i=[],e=2;e<arguments.length;e++)i[e-2]=arguments[e];for(var t=this.joins[n],s=this.options[n],o=0,r=i;o<r.length;o++){var a=r[o],p=void 0,d=void 0;if("string"==typeof a)p=a;else{var c=a[a.length-1],h="string"!=typeof c;h&&(d=c,a=a.slice(0,-1)),p=a[0]}this.joins[n]=t?__spreadArrays(t,[p]):[p],this.options[n]=s?__spreadArrays(s,[d]):[d]}},n.prototype.applyJoins=function(lid,n){var i=n.listener,e=n.instance.id;this.eachJoin(e,i,(function(n){var t=n.joinFnId,s=n.joinInstanceId;t?i.instances[e][t]=function(n){for(var o,r=[],a=1;a<arguments.length;a++)r[a-1]=arguments[a];return(o=i.instances[s])[t].apply(o,__spreadArrays([__spreadArrays([e+"."+t],n)],r))}:i.instances[e][s]=i.instances[s]}))},n.prototype.bindListenerJoined=function(lid,n){var i=this,e=n.instance.id,t=n.listener;this.eachJoin(e,t,(function(n){var s=n.joinInstance;s&&s.listenerJoined&&t.bind(lid,[t.id+".listenerAfterLoaded",e,"**"],[i.id+".callListenerJoined",s.id,{once:!0}])}))},n.prototype.buildPromise=function(lid,n){var i=this,e=n.listener,t=n.instance,s=n.options,o=lid[2];t.then&&(this.promise(o),t.then((function(n){var t;return i.promises[o]=void 0,e.load(lid,((t={})[o]=n,t),__assign(__assign({},s),{reload:void 0}))})).then((function(){i.resolvers[o]()})))},n.prototype.callListenerJoined=function(lid,n){var i=lid[1],e=n.listener.instances[i],t=n.instance,s=__assign(__assign({},n),{instance:e,joinInstance:t});return e.listenerJoined(lid,s)},n.prototype.eachJoin=function(n,i,e){if(this.joins[n])for(var t=0,s=this.joins[n];t<s.length;t++){var o=s[t],r=this.parseId(o,i),a=r[0];e({joinFnId:r[1],joinInstance:i.instances[a],joinInstanceId:a})}},n.prototype.listenerBeforeLoaded=function(lid,n){var i=n.existing,e=n.instance,t=n.listener;if(!e.then){for(var s=0,o=i;s<o.length;s++){var r=o[s];this.listenerBeforeLoadedAny(lid,__assign(__assign({},n),{instance:t.instances[r]}))}t.bind(lid,[t.id+".listenerLoaded","**"],[this.id+".buildPromise",{append:100}],[this.id+".waitForPromises",{append:100.1}],[this.id+".applyJoins",{append:100.2}],[this.id+".bindListenerJoined",{append:100.3}])}},n.prototype.listenerBeforeLoadedAny=function(lid,n){var i=n.instance;n.listener;i.then||(i.join=this.join.bind(this))},n.prototype.listenersJoined=function(lid,n){n.listener,n.instance,n.options},n.prototype.listenerJoined=function(lid,n){},n.prototype.listenerJoins=function(lid,n){},n.prototype.listenerReset=function(lid,n){delete n.join,this.joins={},this.promises={},this.resolvers={}},n.prototype.parseId=function(n,i){var e=i.parseId(n);return[e[0]||n,e[1]]},n.prototype.promise=function(n){var i=this;return this.promises[n]=this.promises[n]||new Promise((function(e){i.resolvers[n]=e}))},n.prototype.waitForPromises=function(lid,n){var i=this,e=n.listener,t=n.instance.id,s=[];if(this.promises[t]&&s.push(this.promises[t]),this.eachJoin(t,e,(function(n){var e=n.joinInstanceId;i.promises[e]&&s.push(i.promises[e])})),s.length)return Promise.all(s)},n}(),join=new Join;export default join;export{Join};